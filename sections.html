
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰</title>

  <!-- Use the updated CSS you pasted (children-style.css) -->
  <link rel="stylesheet" href="children-style.css"/>

  <style>
    /* Page-only tiny tweaks (optional) */
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <main class="app-shell">
    <div class="container">
      <div class="layout">

        <header class="header">
          <section class="welcome" aria-label="Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨">
            <div>
              <h1 id="welcomeTitle">Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h1>
              <p id="welcomeSubtitle">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø«Ù… Ø¯Ø±Ø³Ù‹Ø§: ÙÙŠØ¯ÙŠÙˆ â†’ ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯ â†’ Ø£Ø³Ø¦Ù„Ø©</p>
            </div>
            <div class="quickRow">
              <button class="quickBtn secondary" id="backBtn" type="button"><span class="i">â¬…ï¸</span> Ø±Ø¬ÙˆØ¹</button>
              <button class="quickBtn" id="homeBtn" type="button"><span class="i">ğŸ </span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            </div>
          </section>

          <section class="profileBox" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·ÙÙ„">
            <div class="profileLeft">
              <div class="avatar" id="avatar">ğŸ‘§</div>
              <div class="profileMeta">
                <div class="childName" id="childName">Ø³Ø§Ø±Ø©</div>
                <div class="badgeRow">
                  <div class="badgeIcon" id="badgeIcon">ğŸ…</div>
                  <div class="badgeName" id="badgeName">Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
                </div>
              </div>
            </div>
            <div class="profileRight">
              <button class="tabPill" id="starsTab" type="button" aria-label="Ø§Ù„Ù†Ø¬ÙˆÙ…">
                <div class="left">
                  <div class="ico">â­</div>
                  <div class="txt">
                    <div><span id="starsNo">12</span> Ù†Ø¬Ù…Ø©</div>
                    <small>Ø±ØµÙŠØ¯ÙŠ</small>
                  </div>
                </div>
                <div class="chev">â€º</div>
              </button>

              <button class="tabPill groups" id="groupsTab" type="button" aria-label="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª">
                <div class="left">
                  <div class="ico">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                  <div class="txt">
                    <div><span id="groupsNo">0</span> Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
                    <small>Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</small>
                  </div>
                </div>
                <div class="chev">â€º</div>
              </button>
            </div>
          </section>
        </header>

        <section class="content">
          <div class="split">

            <aside class="pane" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³" id="leftPane">
              <div class="paneHead">
                <div class="paneTitle"><span class="miniDot"></span><span id="leftTitle">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="miniBtn primary" id="reloadBtn" type="button">ØªØ­Ø¯ÙŠØ«</button>
                  <button class="miniBtn" id="groupsViewBtn" type="button">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                  <button class="miniBtn" id="lessonsViewBtn" type="button" style="display:none;">Ø§Ù„Ø¯Ø±ÙˆØ³</button>
                </div>
              </div>

              <div class="sectionsWrap" id="sectionsList"></div>
              <div class="sectionsWrap" id="groupsList" style="display:none;"></div>

              <div class="lessonsPopup" id="lessonsPopup" aria-hidden="true">
                <div class="ddPopup" role="dialog" aria-label="Ø§Ø®ØªØ± Ø¯Ø±Ø³Ù‹Ø§">
                  <div class="ddPopHead">
                    <div class="ddPopTitle">
                      <span class="ddPopIcon">ğŸ“˜</span>
                      <div class="ddPopText">
                        <div class="t1" id="popupTitle">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³</div>
                        <div class="t2" id="popupSub">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¯Ø±Ø³ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
                      </div>
                    </div>

                    <div class="ddHeadBtns">
                      <button class="miniBtn" id="popupAllSectionsBtn" type="button">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
                      <button class="ddCloseBtn" id="ddCloseBtn" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
                    </div>
                  </div>

                  <div class="ddList" id="ddList" role="listbox" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³"></div>
                </div>
              </div>
            </aside>

            <section class="pane viewerBox" aria-label="Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰">
              <div class="viewerTop">
                <div class="lessonTitleRow">
                  <span class="miniDot"></span>
                  <span id="activeLessonTitle">Ø§Ø®ØªØ± Ø¯Ø±Ø³Ù‹Ø§</span>
                  <span class="lessonBadge" id="activeLessonDesc">â€”</span>
                </div>

                <div class="modeTabs">
                  <button class="modeBtn active" id="btnVideo" type="button" disabled>
                    <span>ğŸ¬</span><span>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
                  </button>
                  <button class="modeBtn" id="btnFlash" type="button" disabled>
                    <span>ğŸƒ</span><span>ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯</span>
                  </button>
                  <button class="modeBtn" id="btnQuestions" type="button" disabled>
                    <span>ğŸ§©</span><span>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                  </button>
                </div>
              </div>

              <div class="viewer" id="viewer">
                <div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">
                  Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø«Ù… Ø¯Ø±Ø³Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.
                </div>
              </div>
            </section>

          </div>
        </section>

      </div>
    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div>
      <b id="toastTitle">ØªÙ†Ø¨ÙŠÙ‡</b><br/>
      <span id="toastMsg">...</span>
    </div>
    <button type="button" id="toastClose">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>

```html
<script>
/* =========================================================
  0) CONFIG + URL PARAMS (NO FETCH IF NO ?level=...)
========================================================= */
const DATA_FILE = "sections-lessens.json";
const QUESTIONS_PAGE = "questions.html";

const urlParams = new URL(location.href).searchParams;
const levelIdRaw = urlParams.get("level");              // required
const levelId = levelIdRaw ? levelIdRaw.toLowerCase() : null;

/* =========================================================
  1) DOM HELPERS
========================================================= */
const $ = (s, r = document) => r.querySelector(s);

function esc(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* =========================================================
  2) TOAST
========================================================= */
function showToast(title, msg) {
  $("#toastTitle").textContent = title;
  $("#toastMsg").textContent = msg;
  $("#toast").classList.add("show");
}
function hideToast() {
  $("#toast").classList.remove("show");
}
$("#toastClose")?.addEventListener("click", hideToast);

/* =========================================================
  3) HEADER / CHILD PROFILE (DEMO)
========================================================= */
const CHILD = {
  name: "Ø³Ø§Ø±Ø©",
  avatarEmoji: "ğŸ‘§",
  badge: { iconEmoji: "ğŸ…", name: "Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" },
  stars: 12
};
(function renderShellHeader() {
  $("#childName").textContent = CHILD.name;
  $("#avatar").textContent = CHILD.avatarEmoji;
  $("#badgeIcon").textContent = CHILD.badge.iconEmoji;
  $("#badgeName").textContent = CHILD.badge.name;
  $("#starsNo").textContent = CHILD.stars;
})();

/* =========================================================
  4) APP STATE
========================================================= */
let DATA = null;
let LEVEL = null;

let SECTIONS = [];
let ACTIVE_SECTION = null;
let ACTIVE_LESSON = null;

let activeMode = "video"; // "video" | "flash"

// Flash state
let FLASH_CARDS = [];
let flashIndex = 0;
let flashFlipped = false;

// Single audio channel
const audio = new Audio();

/* =========================================================
  5) AUDIO + SPEAK (TTS)
========================================================= */
function getAudioUrl(obj) {
  return obj?.audioUrl || obj?.soundUrl || "";
}
function playSound(url) {
  if (!url) return showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØª");
  audio.pause();
  audio.src = url;
  audio.currentTime = 0;
  audio.play().catch(() => showToast("ØªÙ†Ø¨ÙŠÙ‡", "ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"));
}

function speakArabic(text) {
  const t = String(text || "").trim();
  if (!t) return;
  if (!("speechSynthesis" in window)) return showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ.");

  try {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(t);
    const voices = window.speechSynthesis.getVoices?.() || [];
    const ar = voices.find(v => (v.lang || "").toLowerCase().startsWith("ar"));
    if (ar) u.voice = ar;
    u.lang = ar?.lang || "ar";
    u.rate = 0.95;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  } catch {
    showToast("ØªÙ†Ø¨ÙŠÙ‡", "ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ.");
  }
}
if ("speechSynthesis" in window) {
  window.speechSynthesis.onvoiceschanged = () => {};
}

/* =========================================================
  6) MODE BUTTONS + VIEW SWITCH
========================================================= */
function enableModeButtons(on) {
  $("#btnVideo").disabled = !on;
  $("#btnFlash").disabled = !on;
  $("#btnQuestions").disabled = !on;
}

function setMode(mode) {
  activeMode = mode;

  $("#btnVideo").classList.toggle("active", mode === "video");
  $("#btnFlash").classList.toggle("active", mode === "flash");
  $("#btnQuestions").classList.remove("active");

  if (!ACTIVE_LESSON) {
    $("#viewer").innerHTML =
      `<div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">Ø§Ø®ØªØ± Ø¯Ø±Ø³Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.</div>`;
    return;
  }

  renderViewer();
}

$("#btnVideo")?.addEventListener("click", () => setMode("video"));
$("#btnFlash")?.addEventListener("click", () => setMode("flash"));

$("#btnQuestions")?.addEventListener("click", () => {
  if (!levelId || !ACTIVE_SECTION || !ACTIVE_LESSON) return;

  const url =
    `${QUESTIONS_PAGE}?level=${encodeURIComponent(levelId)}` +
    `&section=${encodeURIComponent(ACTIVE_SECTION.sectionId)}` +
    `&lesson=${encodeURIComponent(ACTIVE_LESSON.lessonId)}`;

  window.location.href = url;
});

/* =========================================================
  7) POPUP NAV (SECTIONS -> LESSONS)
========================================================= */
function showPopupOnly() {
  $("#lessonsPopup").classList.add("show");
  $("#lessonsPopup").setAttribute("aria-hidden", "false");
  setTimeout(() => $("#ddCloseBtn")?.focus(), 0);
}
function hidePopup() {
  $("#lessonsPopup").classList.remove("show");
  $("#lessonsPopup").setAttribute("aria-hidden", "true");
}
$("#ddCloseBtn")?.addEventListener("click", hidePopup);
$("#popupAllSectionsBtn")?.addEventListener("click", hidePopup);

function renderSectionsList() {
  $("#sectionsList").innerHTML = "";

  if (!SECTIONS.length) {
    $("#sectionsList").innerHTML =
      `<div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù….</div>`;
    return;
  }

  SECTIONS.forEach(sec => {
    const el = document.createElement("div");
    el.className = "sectionItem";
    el.tabIndex = 0;
    el.innerHTML = `
      <div class="sLeft">
        <div class="sIcon">${sec.sectionIcon || "ğŸ“š"}</div>
        <div class="sTxt">
          <div class="sTitle">${esc(sec.sectionTitle || "Ù‚Ø³Ù…")}</div>
          <div class="sDesc">${esc(sec.sectionDesc || "")}</div>
        </div>
      </div>
      <div class="chev">â€º</div>
    `;

    const open = () => selectSection(sec.sectionId);
    el.addEventListener("click", open);
    el.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        open();
      }
    });

    $("#sectionsList").appendChild(el);
  });
}

function buildLessonsPopup(sec) {
  const lessons = Array.isArray(sec.lessons) ? sec.lessons : [];

  $("#ddList").innerHTML = "";
  $("#popupTitle").textContent = sec.sectionTitle || "Ø§Ù„Ø¯Ø±ÙˆØ³";
  $("#popupSub").textContent = lessons.length ? "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¯Ø±Ø³ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³";

  lessons.forEach((L, i) => {
    const item = document.createElement("div");
    item.className = "ddItem";
    item.tabIndex = 0;
    item.dataset.id = L.lessonId;
    item.setAttribute("role", "option");

    item.innerHTML = `
      <div class="ddItemLeft">
        <div class="ddItemTitle">${i + 1} â€” ${esc(L.title || "Ø¯Ø±Ø³")}</div>
        <div class="ddItemDesc">${esc(L.desc || "Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±")}</div>
      </div>
      <div class="ddItemIcon">â–¶</div>
    `;

    const choose = () => selectLesson(L.lessonId);
    item.addEventListener("click", choose);
    item.addEventListener("keydown", e => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        choose();
      }
    });

    $("#ddList").appendChild(item);
  });

  return lessons;
}

function selectSection(sectionId) {
  const sec = SECTIONS.find(s => s.sectionId === sectionId);
  if (!sec) return showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  ACTIVE_SECTION = sec;
  ACTIVE_LESSON = null;

  const lessons = buildLessonsPopup(sec);
  showPopupOnly();

  if (lessons.length) selectLesson(lessons[0].lessonId);
}

/* =========================================================
  8) LESSON SELECT
========================================================= */
function highlightActiveLessonInPopup() {
  document.querySelectorAll("#ddList .ddItem").forEach(el => {
    const isActive = el.dataset.id === (ACTIVE_LESSON?.lessonId || "");
    el.classList.toggle("active", isActive);
    el.style.borderColor = isActive ? "rgba(47,128,237,.55)" : "rgba(31,42,68,.10)";
    el.style.background = isActive ? "rgba(47,128,237,.10)" : "rgba(255,255,255,.92)";
  });
}

function selectLesson(lessonId) {
  const L = (ACTIVE_SECTION?.lessons || []).find(x => x.lessonId === lessonId);
  if (!L) return showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø¯Ø±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

  ACTIVE_LESSON = L;

  $("#activeLessonTitle").textContent = L.title || "Ø¯Ø±Ø³";
  $("#activeLessonDesc").textContent = L.desc || "â€”";

  prepareFlashcardsForLesson(L);

  enableModeButtons(true);
  setMode("video");

  highlightActiveLessonInPopup();
}

/* =========================================================
  9) VIEWER DISPATCH
========================================================= */
function renderViewer() {
  if (activeMode === "video") return renderVideoView();
  return renderFlashView();
}

/* =========================================================
  10) VIDEO
========================================================= */
function renderVideoView() {
  const url = ACTIVE_LESSON?.videoUrl;
  if (!url) {
    $("#viewer").innerHTML =
      `<div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</div>`;
    return;
  }

  $("#viewer").innerHTML = `
    <div class="videoWrap">
      <video controls preload="metadata" playsinline src="${esc(url)}"></video>
    </div>
  `;
}

/* =========================================================
  11) FLASHCARDS
========================================================= */
function prepareFlashcardsForLesson(lesson) {
  const items = Array.isArray(lesson?.items) ? lesson.items : [];
  FLASH_CARDS = items
    .filter(it => it && (it.front || it.back))
    .map(it => ({
      itemId: it.itemId,
      front: it.front || {},
      back: it.back || {}
    }));

  flashIndex = 0;
  flashFlipped = false;
}

function renderFlashView() {
  if (!FLASH_CARDS.length) {
    $("#viewer").innerHTML =
      `<div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙ„Ø§Ø´ ÙƒØ§Ø±Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</div>`;
    return;
  }

  const total = FLASH_CARDS.length;
  const idx = ((flashIndex % total) + total) % total;

  const fc = FLASH_CARDS[idx] || {};
  const front = fc.front || {};
  const back = fc.back || {};
  const face = flashFlipped ? back : front;

  const faceAudio = getAudioUrl(face);
  const showGoQuestions = (idx === total - 1);

  $("#viewer").innerHTML = `
    <div class="viewerScroll">
      <div class="flashStage">
        <button class="navArrow prev" id="prevArrow" type="button" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚" title="Ø§Ù„Ø³Ø§Ø¨Ù‚">â€¹</button>

        <div class="flashCardSingle" id="flashCard" title="Ø§Ø¶ØºØ· Ù„Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©">

          <div class="flashControls">
            <button class="flashIconBtn" id="cardSoundBtn" type="button" aria-label="ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª" ${faceAudio ? "" : "disabled"} data-tip="Ø§Ø³Ù…Ø¹">
              <span class="ico">ğŸ”Š</span>
            </button>
            <button class="flashIconBtn" id="cardSpeakBtn" type="button" aria-label="Ù‚Ø±Ø§Ø¡Ø©" data-tip="Ø§Ù‚Ø±Ø£">
              <span class="ico">ğŸ—£ï¸</span>
            </button>
          </div>

          <div class="flashSidePill">${flashFlipped ? "Ø§Ù„Ø®Ù„Ù" : "Ø§Ù„Ø£Ù…Ø§Ù…"}</div>

          <img class="flashImg" id="cardImg" alt="card image"/>
          <div class="flashText" id="cardText"></div>
          <div class="flashDesc" id="cardDesc"></div>
          <div class="hintLine">Ø§Ø¶ØºØ· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù‚Ù„Ø¨Ù‡Ø§</div>
        </div>

        <button class="navArrow next" id="nextArrow" type="button" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ" title="Ø§Ù„ØªØ§Ù„ÙŠ">â€º</button>
      </div>

      <div class="flashFooter" style="margin-top:12px;">
        <div class="flashCounter">Ø¨Ø·Ø§Ù‚Ø© ${idx + 1} Ù…Ù† ${total}</div>
        ${showGoQuestions ? `<button class="miniBtn primary" id="goQuestions" type="button">ğŸ§© Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>` : ``}
      </div>
    </div>
  `;

  $("#cardImg").src = face.imageUrl || "";
  $("#cardText").textContent = face.text || "â€”";
  $("#cardDesc").textContent = face.desc || "";

  $("#cardSoundBtn")?.addEventListener("click", (e) => {
    e.stopPropagation();
    playSound(faceAudio);
  });

  $("#cardSpeakBtn")?.addEventListener("click", (e) => {
    e.stopPropagation();
    speakArabic([face.text, face.desc].filter(Boolean).join(" â€” "));
  });

  $("#flashCard")?.addEventListener("click", () => {
    flashFlipped = !flashFlipped;
    renderFlashView();
  });

  $("#prevArrow")?.addEventListener("click", (e) => {
    e.stopPropagation();
    flashIndex = (idx - 1 + total) % total;
    flashFlipped = false;
    renderFlashView();
  });

  $("#nextArrow")?.addEventListener("click", (e) => {
    e.stopPropagation();
    flashIndex = (idx + 1) % total;
    flashFlipped = false;
    renderFlashView();
  });

  if (showGoQuestions) {
    $("#goQuestions")?.addEventListener("click", () => {
      if (!levelId || !ACTIVE_SECTION || !ACTIVE_LESSON) return;

      const url =
        `${QUESTIONS_PAGE}?level=${encodeURIComponent(levelId)}` +
        `&section=${encodeURIComponent(ACTIVE_SECTION.sectionId)}` +
        `&lesson=${encodeURIComponent(ACTIVE_LESSON.lessonId)}`;

      window.location.href = url;
    });
  }
}

/* =========================================================
  12) DATA LOADING
========================================================= */
function normalize(raw) { return raw || {}; }

function findLevel(d, id) {
  const levels = Array.isArray(d?.levels) ? d.levels : [];
  const key = String(id || "").toLowerCase();
  return levels.find(l => String(l.levelId || "").toLowerCase() === key) || null;
}

async function loadFromFile() {
  // ğŸš« NO level param â†’ NO fetch
  if (!levelId) {
    DATA = null;
    LEVEL = null;
    SECTIONS = [];
    ACTIVE_SECTION = null;
    ACTIVE_LESSON = null;

    renderSectionsList();
    enableModeButtons(false);

    $("#welcomeTitle").textContent = "Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰";
    $("#welcomeSubtitle").textContent = "Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";

    $("#viewer").innerHTML = `
      <div class="viewerScroll" style="color:var(--muted);font-weight:900;line-height:1.8;">
        Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØºØ©:<br/>
        <span dir="ltr" style="font-family:monospace;">sections.html?level=preliminary</span>
      </div>
    `;

    showToast("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· (?level=...)");
    return;
  }

  // âœ… level exists â†’ fetch JSON
  try {
    const res = await fetch(DATA_FILE, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    DATA = normalize(await res.json());

    // Apply UI defaults
    if (DATA?.uiDefaults) {
      if (typeof DATA.uiDefaults.rtl === "boolean") {
        document.documentElement.dir = DATA.uiDefaults.rtl ? "rtl" : "ltr";
      }
      if (DATA.uiDefaults.lang) {
        document.documentElement.lang = DATA.uiDefaults.lang;
      }
    }

    LEVEL = findLevel(DATA, levelId);

    if (!LEVEL) {
      SECTIONS = [];
      renderSectionsList();
      enableModeButtons(false);
      showToast("ØªÙ†Ø¨ÙŠÙ‡", `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (${levelId}) ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`);
      return;
    }

    // Normalize ids for consistent matching
    SECTIONS = Array.isArray(LEVEL.sections)
      ? LEVEL.sections.map(sec => ({
          ...sec,
          sectionId: String(sec.sectionId || "").toLowerCase(),
          lessons: Array.isArray(sec.lessons)
            ? sec.lessons.map(l => ({
                ...l,
                lessonId: String(l.lessonId || "").toLowerCase()
              }))
            : []
        }))
      : [];

    $("#welcomeTitle").textContent = LEVEL.levelTitle || "Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰";
    $("#welcomeSubtitle").textContent = LEVEL.levelDesc || "Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø«Ù… Ø¯Ø±Ø³Ù‹Ø§";

    renderSectionsList();
    enableModeButtons(false);

  } catch (err) {
    DATA = null;
    LEVEL = null;
    SECTIONS = [];
    renderSectionsList();
    enableModeButtons(false);
    showToast("Ø®Ø·Ø£", "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
  }
}

/* =========================================================
  13) TOP NAV
========================================================= */
$("#reloadBtn")?.addEventListener("click", loadFromFile);
$("#backBtn")?.addEventListener("click", () => history.back());
$("#homeBtn")?.addEventListener("click", () => (window.location.href = "dashboard.html"));
$("#starsTab")?.addEventListener("click", () => showToast("Ø§Ù„Ù†Ø¬ÙˆÙ… â­", `Ø±ØµÙŠØ¯Ùƒ: ${CHILD.stars}`));

/* =========================================================
  14) START
========================================================= */
loadFromFile();
</script>


</body>
</html>
