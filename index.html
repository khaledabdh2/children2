<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Quiz</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

  <style>
:root{
  --bg1:#f6f7fb; --bg2:#eef2ff;
  --ink:#0f172a; --muted:rgba(15,23,42,.62);
  --card:rgba(255,255,255,.92);
  --border:rgba(15,23,42,.10);
  --shadow:0 18px 44px rgba(15,23,42,.10);

  --r-xl: clamp(18px, 1.8vw, 28px);

  --fs0: clamp(12px, .25vw + 11px, 14px);
  --fs1: clamp(14px, .35vw + 13px, 16.5px);
  --fs2: clamp(16px, .55vw + 15px, 20px);

  --btnH: clamp(42px, 5.2vh, 50px);

  --pad: clamp(10px, 1.2vw, 16px);
  --gap: clamp(8px, 1.1vw, 12px);

  --imgSz: clamp(54px, 5.6vw, 76px);
  --choiceImgH: clamp(120px, 20vh, 220px);

  /* MATCH */
  --matchImgH: clamp(72px, 12vw, 120px);
  --matchPadX: clamp(8px, 4vw, 56px);

  /* DRAG & DROP + CLASSIFICATION */
  --ddColGap: clamp(10px, 4vw, 48px);
  --ddRowGap: clamp(8px, 1.2vw, 14px);
  --ddCardH:  clamp(64px, 8vh, 86px);
  --ddImg:    clamp(54px, 6vw, 78px);

  /* Classification chip remove */
  --chipX: clamp(22px, 2.6vw, 26px);
}

html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 15% 20%, rgba(59,130,246,.20), transparent 55%),
    radial-gradient(900px 520px at 85% 15%, rgba(245,158,11,.18), transparent 60%),
    radial-gradient(900px 520px at 70% 90%, rgba(16,185,129,.16), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.appWrap{min-height:100vh; padding:var(--pad);}
.app{
  max-width: 1180px;
  margin: 0 auto;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  box-shadow: var(--shadow);
  overflow: hidden;
  display:flex;
  flex-direction:column;
  min-height: calc(100vh - (var(--pad) * 2));
}
@media (max-width: 768px){
  .appWrap{padding:0}
  .app{border-radius:0; min-height:100vh;}
}

.topBar{
  background: rgba(255,255,255,.96);
  border-bottom:1px solid rgba(15,23,42,.08);
  padding: clamp(8px, 1vw, 12px) clamp(10px, 1.2vw, 14px);
  flex: 0 0 auto;
}

.qHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: var(--gap);
}
.qTitle{
  font-size: var(--fs2);
  font-weight: 1000;
  line-height: 1.15;
  margin: 0;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow:hidden;
}
.qSub{
  font-size: var(--fs0);
  color:var(--muted);
  font-weight:900;
  margin: 4px 0 0;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow:hidden;
}

.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border-radius:999px;
  font-weight:1000; font-size:var(--fs0);
  background: rgba(15,23,42,.04);
  border: 1px solid rgba(15,23,42,.08);
  white-space:nowrap;
}

@media (max-width: 520px){
  .topMeta{display:none !important;}
}

.btnKid{
  height: var(--btnH);
  border-radius: 14px;
  font-weight:1000;
  font-size: var(--fs1);
  box-shadow: 0 10px 18px rgba(15,23,42,.10);
  border:0;
  transition: transform .12s ease, opacity .16s ease;
  padding-inline: 14px;
}
.btnKid:active{transform:scale(.99)}
.btnKid[disabled]{opacity:.55; transform:none; cursor:not-allowed}
.btnPrimary{color:#fff; background: linear-gradient(135deg, rgba(59,130,246,.98), rgba(139,92,246,.98));}
.btnSecondary{
  color: var(--ink);
  background: rgba(255,255,255,.98);
  border: 1px solid rgba(15,23,42,.12);
  box-shadow: 0 8px 14px rgba(15,23,42,.08);
}

.btnSound{
  height: var(--btnH);
  min-width: 56px;
  border-radius: 14px;
  font-weight:1000;
  border:0;
  color:#fff;
  background: linear-gradient(135deg, rgba(16,185,129,.98), rgba(59,130,246,.98));
  box-shadow: 0 10px 18px rgba(15,23,42,.10);
  transition: transform .12s ease, opacity .16s ease;
}
.btnSound:active{transform:scale(.99)}
.btnSound[disabled]{opacity:.55; transform:none; cursor:not-allowed}

.topMeta{
  display:flex;
  flex-wrap:wrap;
  gap: var(--gap);
  justify-content: flex-start;
  margin-top: var(--gap);
}

.stage{
  flex:1;
  padding: var(--pad);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  min-height: 0;
}
@media (min-width: 768px){
  .stage{ overflow:hidden; }
}

.panelKid{
  background: rgba(255,255,255,.96);
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: 0 8px 14px rgba(15,23,42,.06);
  border-radius: var(--r-xl);
  padding: var(--pad);
}
.panelFlex{display:flex; flex-direction:column; min-height:0;}
.panelBodyGrow{flex:1; min-height:0;}

.panelTitle{font-weight:1000; font-size:var(--fs1); margin:0 0 10px}
.panelTitle small{color:var(--muted); font-weight:900; font-size:var(--fs0)}

.cardBtn{
  text-align: right;
  border-radius: var(--r-xl);
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.98);
  box-shadow: 0 10px 18px rgba(15,23,42,.08);
  padding: clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  transition: transform .12s ease, border-color .15s ease, box-shadow .15s ease;
  cursor:pointer;

  width: fit-content;
  min-width: clamp(180px, 24vw, 320px);
  max-width: 100%;
}
.cardBtn:active{ transform: scale(.995); }
.cardBtn[data-selected="1"]{
  border-color: rgba(59,130,246,.55);
  box-shadow: 0 14px 26px rgba(59,130,246,.14);
}

.cardLeft{display:flex; align-items:center; gap: 10px; min-width:0;}
.cardImg{
  width: var(--imgSz);
  height: var(--imgSz);
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(15,23,42,.03);
  object-fit: cover;
  flex:0 0 auto;
}
.cardText{
  font-weight: 1000;
  font-size: var(--fs1);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width: 42ch;
}

/* Choice cards */
.choiceGrid{
  display:grid;
  gap: var(--gap);
  grid-template-columns: repeat(auto-fit, minmax(min(260px, 100%), 1fr));
  align-items:stretch;
  justify-items:stretch;
  min-height: 0;
}
@media (min-width: 992px){ .choiceGrid{ grid-template-columns: repeat(4, 1fr); } }
@media (min-width: 768px) and (max-width: 991.98px){ .choiceGrid{ grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 767.98px){ .choiceGrid{ grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 520px){ .choiceGrid{ grid-template-columns: 1fr; } }

.choiceCard{
  width: 100% !important;
  min-width: 0 !important;
  height: 100%;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  justify-content:flex-start;
  text-align:center;
  padding: clamp(10px, 1.1vw, 14px);
  gap: 10px;
}
.choiceImgWrap{
  width:100%;
  border-radius: clamp(16px, 1.6vw, 22px);
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(15,23,42,.03);
  overflow:hidden;
  box-shadow: 0 8px 14px rgba(15,23,42,.06);
  height: var(--choiceImgH);
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
}
.choiceImg{width:100%; height:100%; object-fit: cover; display:block;}
.choiceName{
  font-weight: 1000;
  font-size: var(--fs1);
  line-height: 1.2;
  padding: 2px 6px 0;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow:hidden;
  min-height: calc(var(--fs1) * 2.3);
}
.choiceAudioRow{display:flex; justify-content:center; margin-top:auto;}

.vList{display:flex; flex-direction:column; gap: var(--gap); align-items:stretch;}
.dropZone{
  width: 100%;
  border-radius: var(--r-xl);
  border: 2px dashed rgba(15,23,42,.18);
  background: rgba(15,23,42,.02);
  padding: clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  min-height: clamp(64px, 7.2vh, 86px);
}
.dropZone[data-active="1"]{
  border-color: rgba(59,130,246,.55);
  background: rgba(59,130,246,.06);
}
.zoneFill{
  font-weight:1000;
  font-size: var(--fs0);
  color: rgba(15,23,42,.70);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.90);
  white-space:nowrap;
  max-width: 48%;
  overflow:hidden;
  text-overflow:ellipsis;
}
.dragItem{ user-select:none; }
.dragging{ opacity:.75; transform: scale(.99); }

.orderIdx{
  width: 36px;
  height: 36px;
  border-radius: 12px;
  display:grid;
  place-items:center;
  font-weight: 1000;
  background: rgba(59,130,246,.10);
  border: 1px solid rgba(59,130,246,.18);
  flex: 0 0 auto;
}
.iconBtn{
  width: 42px;
  height: 42px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.98);
  box-shadow: 0 8px 14px rgba(15,23,42,.06);
  font-weight: 1000;
  flex: 0 0 auto;
}
.iconBtn:disabled{ opacity:.45; }

.footerControls{
  margin-top: var(--gap);
  display:flex;
  flex-wrap:wrap;
  gap: var(--gap);
  align-items:center;
  justify-content:flex-start;
}
.footerControls .btnKid{flex: 0 0 auto;}
@media (max-width: 520px){
  .footerControls .btnKid{flex: 1 1 auto;}
}

.grid2_1{
  display:grid;
  gap: var(--gap);
  grid-template-columns: 1fr;
  align-items:stretch;
  min-height:0;
}
@media (min-width: 992px){
  .grid2_1{grid-template-columns: 2fr 1fr;}
}

.paintCanvas,.traceCanvas{
  width:100%;
  display:block;
  border-radius: clamp(16px, 1.8vw, 22px);
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: 0 10px 18px rgba(15,23,42,.08);
  background: rgba(255,255,255,.98);
  touch-action:none;
}

.swatch{
  width: clamp(30px, 3.8vw, 36px);
  height: clamp(30px, 3.8vw, 36px);
  border-radius: 14px;
  border: 2px solid rgba(15,23,42,.15);
  cursor:pointer;
  box-shadow: 0 8px 14px rgba(15,23,42,.08);
}
.swatch[data-selected="1"]{outline: 4px solid rgba(59,130,246,.55); outline-offset: 2px;}

.toastKid{
  position: fixed;
  left: 16px;
  bottom: 16px;
  z-index: 3000;
  width: min(380px, calc(100% - 32px));
  background: rgba(255,255,255,.96);
  border: 1px solid rgba(15,23,42,.12);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 12px;
  display:none;
  gap: 10px;
  align-items:center;
  justify-content: space-between;
}
.toastKid.show{display:flex;}
.toastKid b{font-weight:1000}

.correctPulse{ animation: correctPulse .6s ease-out; }
@keyframes correctPulse{ 0%{transform:scale(1)} 40%{transform:scale(1.08)} 100%{transform:scale(1)} }
.wrongShake{ animation: wrongShake .45s ease-in-out; }
@keyframes wrongShake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-6px)}
  50%{transform:translateX(6px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}
.starBurst{
  position: fixed; inset: 0;
  pointer-events:none;
  display:grid; place-items:center;
  z-index: 4000;
  font-size: 52px;
  animation: burst .7s ease-out forwards;
}
@keyframes burst{
  0%{opacity:0; transform:scale(.6)}
  40%{opacity:1; transform:scale(1.2)}
  100%{opacity:0; transform:scale(1.6)}
}

/* =========================================================
   MATCH â€” TWO COLUMNS + FULL IMAGE DISPLAY
   ========================================================= */
.pairGrid{
  display: flex;
  flex-direction: column;
  gap: clamp(8px, 1.2vw, 14px);
  width: 100%;
  padding-inline: var(--matchPadX);
  box-sizing: border-box;
}
.pairRow{
  display: flex;
  width: 100%;
  align-items: stretch;
  gap: clamp(8px, 6vw, 56px);
}
.pairRow > .cardBtn{
  flex: 0 0 50%;
  max-width: 50%;
  min-width: 0;
  height: var(--matchImgH);
  padding: 0 !important;
  display: flex;
  align-items: stretch;
  justify-content: stretch;
  border-radius: clamp(14px, 2vw, 18px);
}
.pairRow [data-left]{ overflow: hidden; }
.pairRow [data-left] .cardLeft{
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
}
.pairRow [data-left] .matchLeftImg{
  width: 100% !important;
  height: 100% !important;
  display: block;
  object-fit: contain;
  object-position: center;
  border: 0;
  background: rgba(15,23,42,.03);
  border-radius: inherit;
}
.pairRow [data-left] .cardText{
  width: 100%;
  height: 100%;
  display: grid;
  place-items: center;
  text-align: center;
  font-weight: 1000;
  padding: 10px 12px;
  white-space: normal;
}
.pairRow [data-right]{
  display: flex;
  align-items: center;
  justify-content: center;
}
.pairRow [data-right] .cardLeft{
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pairRow [data-right] .cardText{
  width: 100%;
  max-width: 100%;
  text-align: center;
  white-space: normal;
  overflow: hidden;
  padding: 10px 14px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
@media (max-width: 520px){
  .pairRow{ gap: clamp(6px, 3vw, 10px); }
}
@media (min-width: 992px){
  .pairRow{ gap: clamp(24px, 6vw, 72px); }
}

/* =========================================================
   DRAG & DROP + CLASSIFICATION â€” TWO COLUMNS ALWAYS
   ========================================================= */
.twoColGrid{
  display: grid;
  grid-template-columns: 1fr 1fr; /* always two columns (phone too) */
  gap: var(--ddColGap);
  align-items: stretch;
  width: 100%;
}
.twoColGrid > .panelKid{
  min-width: 0 !important;
  height: 100%;
}
.twoColGrid .panelFlex{ min-height: 0; }
.twoColGrid .panelBodyGrow{
  min-height: 0;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* =========================================================
   DRAG & DROP â€” HEIGHT SYNC + FULL IMAGES
   ========================================================= */
#ddLeft .cardBtn{
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;

  height: var(--ddCardH);
  padding: 10px 12px !important;

  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
#ddLeft .cardLeft{
  height: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
}
#ddLeft .cardImg{
  width: var(--ddImg) !important;
  height: var(--ddImg) !important;
  object-fit: contain !important;
  object-position: center;
  background: rgba(15,23,42,.03);
  flex: 0 0 auto;
}
#ddLeft .cardText{
  white-space: normal !important;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  max-width: 100% !important;
}
#ddRight .dropZone{
  width: 100%;
  min-height: var(--ddCardH);
  padding: 10px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
#ddRight .dropZone > .d-flex{
  height: 100%;
  min-width: 0;
  align-items: center;
}
#ddRight .dropZone .cardImg{
  width: var(--ddImg) !important;
  height: var(--ddImg) !important;
  object-fit: contain !important;
  object-position: center;
  background: rgba(15,23,42,.03);
}
#ddRight .dropZone .d-flex > div{
  white-space: normal !important;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
#ddRight .zoneFill{
  max-width: 42%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Small screens: smaller gap + slightly smaller image */
@media (max-width: 520px){
  :root{
    --ddColGap: clamp(8px, 3vw, 12px);
    --ddCardH:  clamp(60px, 10vh, 76px);
    --ddImg:    clamp(46px, 9vw, 64px);
  }
}

/* =========================================================
   CLASSIFICATION â€” REMOVABLE CHIPS (X inside the category)
   ========================================================= */
.clsChip{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 1000;
  font-size: var(--fs0);
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.18);
  line-height: 1;
}

.clsX{
  width: var(--chipX);
  height: var(--chipX);
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  background: rgba(255,255,255,.95);
  display: grid;
  place-items: center;
  cursor: pointer;
  font-weight: 1000;
  box-shadow: 0 6px 12px rgba(15,23,42,.08);
  flex: 0 0 auto;
}
.clsX:active{ transform: scale(.98); }

/* =========================================================
   ORDERING â€” OPTIONS WIDTH 70%
   ========================================================= */
#orderList{
  display: flex;
  flex-direction: column;
  align-items: center;
}
#orderList > .cardBtn{
  width: 70% !important;
  max-width: 70% !important;
  min-width: 70% !important;
  margin-inline: auto;
}
@media (max-width: 520px){
  #orderList > .cardBtn{
    width: 92% !important;
    max-width: 92% !important;
    min-width: 92% !important;
  }
}
  </style>
</head>

<body>
  <div class="appWrap">
    <div class="app">
      <div class="topBar">
        <div class="qHead">
          <button class="btnSound" id="btnSound" type="button" disabled>ğŸ”Š</button>
          <div style="flex:1; min-width:0;">
            <h1 class="qTitle" id="qTitle">â€”</h1>
            <p class="qSub" id="qSub">â€”</p>
            <div class="topMeta" id="topMeta">
              <span class="pill" id="pillLesson">â€”</span>
              <span class="pill" id="pillProgress">0/0</span>
              <span class="pill" id="pillType">â€”</span>
            </div>
          </div>
        </div>
      </div>

      <div class="stage" id="stage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <div class="toastKid" id="toastKid" role="status" aria-live="polite">
    <div>
      <b id="toastTitle">â€”</b><br/>
      <span id="toastMsg">â€”</span>
    </div>
    <button class="btnKid btnSecondary px-3" id="toastClose" type="button" style="height:44px">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>

<script>
/* =========================
  SETTINGS
========================= */
const DATA_FILE = "sections-lessens.json";
const urlParams = new URL(location.href).searchParams;
const levelId   = (urlParams.get("level")   || "preliminary").toLowerCase();
const sectionId = (urlParams.get("section") || "").toLowerCase();
const lessonId  = (urlParams.get("lesson")  || "");

const audio = new Audio();

/* =========================
  HELPERS
========================= */
const esc = (s) => String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const norm = (s) => String(s||"").replace(/\s+/g," ").trim();
const isTouch = () => matchMedia("(max-width: 900px)").matches || ("ontouchstart" in window);

function toast(title, msg){
  $("#toastTitle").text(title);
  $("#toastMsg").text(msg);
  $("#toastKid").addClass("show");
}
function toastHide(){ $("#toastKid").removeClass("show"); }

function burstStars(){
  const d = document.createElement("div");
  d.className = "starBurst";
  d.textContent = "â­ğŸ‰â­";
  document.body.appendChild(d);
  setTimeout(()=>d.remove(), 700);
}
function animCorrect($el){
  const el = ($el && $el[0]) ? $el[0] : $("#stage")[0];
  el.classList.add("correctPulse");
  burstStars();
  setTimeout(()=>el.classList.remove("correctPulse"), 650);
}
function animWrong($el){
  const el = ($el && $el[0]) ? $el[0] : $("#stage")[0];
  el.classList.add("wrongShake");
  setTimeout(()=>el.classList.remove("wrongShake"), 460);
}

function playSound(url){
  if(!url){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ØµÙˆØª"); return; }
  audio.pause();
  audio.src = url;
  audio.currentTime = 0;
  audio.play().catch(()=>toast("ØªÙ†Ø¨ÙŠÙ‡","ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª"));
}

function pickText(o){
  return String(o?.text ?? o?.label ?? o?.name ?? o?.letter ?? "").trim();
}
function visualSrc(o){
  const img = String(o?.imageUrl ?? "").trim();
  return img || "";
}

function hintFor(type){
  const touch = isTouch();
  return ({
    multiple_choice: "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø«Ù… Ø§Ø¶ØºØ· (ØªØ­Ù‚Ù‚)",
    listen_choose:   "Ø§Ø¶ØºØ· (Ø§Ø³Ù…Ø¹) Ø«Ù… Ø§Ø®ØªØ± Ø«Ù… (ØªØ­Ù‚Ù‚)",
    match:           "Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ø«Ù… Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø«Ù… (ØªØ­Ù‚Ù‚)",
    drag_drop:       touch ? "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù†ØµØ± Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„Ù‡Ø¯Ù" : "Ø§Ø³Ø­Ø¨ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù",
    ordering:        touch ? "Ø§Ø³ØªØ®Ø¯Ù… â¬†ï¸â¬‡ï¸ Ø«Ù… (ØªØ­Ù‚Ù‚)" : "Ø§Ø³Ø­Ø¨ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø«Ù… (ØªØ­Ù‚Ù‚)",
    classification:  touch ? "Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„ÙØ¦Ø©" : "Ø§Ø³Ø­Ø¨ ÙƒÙ„ Ø¹Ù†ØµØ± Ù„Ù„ÙØ¦Ø© Ø«Ù… (ØªØ­Ù‚Ù‚)",
    coloring:        "Ù„ÙˆÙ‘Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´ÙƒÙ„ ÙÙ‚Ø· Ø«Ù… (ØªØ­Ù‚Ù‚)",
    build_construct: "Ø§Ø¶ØºØ· Ø§Ù„Ù‚Ø·Ø¹ Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø«Ù… (ØªØ­Ù‚Ù‚)",
    trace_write:     "Ø§ÙƒØªØ¨ ÙÙˆÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø«Ù… (ØªØ­Ù‚Ù‚)"
  })[type] || "Ø§Ø®ØªØ±/Ø­Ø±Ù‘Ùƒ Ø«Ù… Ø§Ø¶ØºØ· (ØªØ­Ù‚Ù‚)";
}

function setTop({title, sub, lesson, progress, type, audioUrl}){
  $("#qTitle").text(title || "Ø³Ø¤Ø§Ù„");
  $("#qSub").text(sub || "");
  $("#pillLesson").text(lesson || "â€”");
  $("#pillProgress").text(progress || "â€”");
  $("#pillType").text(type || "â€”");

  const $btn = $("#btnSound");
  $btn.prop("disabled", !audioUrl);
  $btn.off("click").on("click", () => playSound(audioUrl));
}

function feedback(ok, msg, $target){
  toast(ok ? "ØµØ­ÙŠØ­ âœ…" : "Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ”„", msg);
  const fb = state.lesson?.interactive?.feedbackAudio || {};
  const snd = ok ? fb.correct : fb.wrong;
  if(snd) playSound(snd);
  ok ? animCorrect($target) : animWrong($target);
}

/* =========================
  FOOTER CONTROLS
========================= */
function footerControls(){
  return `
    <div class="footerControls" id="footerControls">
      <button class="btnKid btnPrimary" id="btnCheck" type="button">âœ… ØªØ­Ù‚Ù‚</button>
      <button class="btnKid btnSecondary" id="btnTry" type="button">ğŸ” Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
      <button class="btnKid btnSecondary" id="btnBack" type="button">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
    </div>
  `;
}
function wireFooter(){
  $("#btnCheck").off("click").on("click", ()=>validate());
  $("#btnTry").off("click").on("click", ()=>{ resetQ(); render(); });
  $("#btnBack").off("click").on("click", ()=>history.back());
  $("#toastClose").off("click").on("click", toastHide);
}

/* =========================
  DATA + FLOW
========================= */
const state = {
  data:null, level:null, section:null, lesson:null,
  flow:[], idx:0,
  q:{},
  dragId:"",
  selectedForTap:null,
  paint:null,
  trace:null
};

function findBy(arr, key, val){
  return (Array.isArray(arr)?arr:[])
    .find(x => String(x?.[key]||"").toLowerCase() === String(val||"").toLowerCase()) || null;
}
function findLesson(level, section, lesson){
  const sec = findBy(level?.sections, "sectionId", section);
  if(!sec) return {sec:null, les:null};
  const les = (Array.isArray(sec.lessons)?sec.lessons:[])
    .find(L => String(L.lessonId||"") === String(lesson)) || null;
  return {sec, les};
}
function buildFlow(lesson){
  const inter = lesson?.interactive || {};
  const byItem = inter.flowByItem || {};
  const bank = Array.isArray(inter.questionBank) ? inter.questionBank : [];
  const byId = new Map(bank.map(q => [q.id, q]));
  const out = [];
  Object.entries(byItem).forEach(([itemId, ids]) => {
    const seen = new Set();
    (ids||[]).forEach(qId => {
      if(seen.has(qId)) return;
      seen.add(qId);
      const qObj = byId.get(qId);
      if(qObj) out.push({itemId, qId, q: qObj});
    });
  });
  return out;
}

function getItemById(itemId){
  return (state.lesson?.items || []).find(it => String(it.itemId) === String(itemId)) || null;
}
function resolveQuestion(entry){
  const q = entry?.q || {};
  const item = getItemById(entry.itemId);
  const itemText = String(item?.front?.text || item?.back?.title || "").trim();

  const out = JSON.parse(JSON.stringify(q));
  out.prompt = out.prompt || {};

  if(String(out.prompt.text || "").includes("{item}")){
    out.prompt.text = String(out.prompt.text).replaceAll("{item}", itemText);
  }
  if(!out.prompt.imageUrl && item?.front?.imageUrl) out.prompt.imageUrl = item.front.imageUrl;
  if(!out.prompt.audioUrl && item?.front?.audioUrl) out.prompt.audioUrl = item.front.audioUrl;

  if(out.type === "build_construct"){
    out.answer = out.answer || {};
    if(!out.answer.text && itemText) out.answer.text = itemText;
  }
  return out;
}

/* =========================
  GLOBAL DND
========================= */
$(document).on("dragstart", "[data-dragid],[data-orderid]", function(e){
  state.dragId = $(this).attr("data-dragid") || $(this).attr("data-orderid") || "";
  $(this).addClass("dragging");
  try{ e.originalEvent.dataTransfer.setData("text/plain", state.dragId); }catch(_){}
});
$(document).on("dragend", "[data-dragid],[data-orderid]", function(){
  $(this).removeClass("dragging");
  state.dragId = "";
});
$(document).on("dragover", "[data-dropid],[data-orderid]", function(e){ e.preventDefault(); });
$(document).on("dragenter", "[data-dropid]", function(){ $(this).attr("data-active","1"); });
$(document).on("dragleave", "[data-dropid]", function(e){
  if(this.contains(e.relatedTarget)) return;
  $(this).attr("data-active","0");
});

/* =========================
  CORE
========================= */
function resetQ(){
  state.q = {};
  state.selectedForTap = null;
  state.paint = null;
  state.trace = null;
}
function curEntry(){ return state.flow[state.idx]; }
function progressText(){ return `${Math.min(state.idx+1, state.flow.length)}/${state.flow.length}`; }

/* =========================
  CLASSIFICATION (UPDATED)
  - removed "Ù…Ø³Ø­" button
  - each assigned item shows (x) inside the category
  - clicking (x) removes it
  - phone stays 2 columns via .twoColGrid CSS (already)
========================= */
function renderClassification(entry){
  const q = entry.q;
  const items = Array.isArray(q.items)?q.items:[];
  const cats  = Array.isArray(q.categories)?q.categories:[];
  state.q.catAssign ??= {};

  setTop({
    title: q?.prompt?.text || "ØµÙ†Ù‘Ù",
    sub: hintFor("classification"),
    lesson: state.lesson?.title || "â€”",
    progress: progressText(),
    type: "ØªØµÙ†ÙŠÙ",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const itemsHtml = items.map(it => {
    const used = !!state.q.catAssign[String(it.id)];
    const img = visualSrc(it);
    const txt = pickText(it);
    return `
      <button class="cardBtn dragItem" type="button"
        ${isTouch() ? "" : `draggable="true"`}
        data-dragid="${esc(it.id)}"
        style="${used ? "opacity:.55" : ""}">
        <div class="cardLeft">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          ${txt ? `<div class="cardText">${esc(txt)}</div>` : ``}
        </div>
      </button>
    `;
  }).join("");

  const catsHtml = cats.map(c => {
    const label = String(c.label ?? c.name ?? c.text ?? "");
    const assigned = items
      .filter(it => String(state.q.catAssign[String(it.id)]||"") === String(c.id))
      .map(it => ({ id: String(it.id), text: pickText(it) }))
      .filter(x => x.text);

    return `
      <div class="dropZone" data-dropid="${esc(c.id)}" data-active="0"
           style="flex-direction:column; align-items:stretch;">
        <div class="d-flex align-items-center justify-content-between gap-2">
          <div style="font-weight:1000; font-size:var(--fs1);">${esc(label || "ÙØ¦Ø©")}</div>
          <span class="pill">${assigned.length} Ø¹Ù†ØµØ±</span>
        </div>

        <div class="mt-2" style="display:flex; gap:8px; flex-wrap:wrap;">
          ${
            assigned.length
              ? assigned.map(a => `
                  <span class="clsChip">
                    <span>${esc(a.text)}</span>
                    <button type="button" class="clsX" title="Ø­Ø°Ù" aria-label="Ø­Ø°Ù"
                            data-unassign="${esc(a.id)}">Ã—</button>
                  </span>
                `).join("")
              : `<span class="pill">Ø¶Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§</span>`
          }
        </div>
      </div>
    `;
  }).join("");

  $("#stage").html(`
    <div class="twoColGrid">
      <div class="panelKid panelFlex">
        <p class="panelTitle">Ø§Ù„Ø¹Ù†Ø§ØµØ± <small>${isTouch() ? "Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±" : "Ø§Ø³Ø­Ø¨"}</small></p>
        <div class="vList panelBodyGrow" id="clsItems">${itemsHtml}</div>
        ${isTouch() ? `<div class="mt-2"><span class="pill">Ø§Ù„Ù…Ø®ØªØ§Ø±: <span id="clsPick">â€”</span></span></div>` : ``}
      </div>

      <div class="panelKid panelFlex">
        <p class="panelTitle">Ø§Ù„ÙØ¦Ø§Øª <small>${isTouch() ? "Ø§Ø¶ØºØ· Ø§Ù„ÙØ¦Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±" : "Ø¥ÙÙ„Ø§Øª"}</small></p>
        <div class="vList panelBodyGrow" id="clsCats">${catsHtml}</div>
      </div>
    </div>

    ${footerControls()}
  `);

  if(isTouch()){
    const name = state.selectedForTap ? pickText(items.find(d=>String(d.id)===String(state.selectedForTap))||{}) : "â€”";
    $("#clsPick").text(name || "â€”");
  }

  // Desktop drop into category
  $("#stage").off("drop.cls").on("drop.cls", "#clsCats [data-dropid]", function(e){
    e.preventDefault();
    $(this).attr("data-active","0");

    const catId = $(this).attr("data-dropid");
    const itemId = state.dragId;
    if(!catId || !itemId) return;

    state.q.catAssign = state.q.catAssign || {};
    state.q.catAssign[String(itemId)] = String(catId);
    render();
  });

  // Touch: pick item
  $("#stage").off("click.clsPick").on("click.clsPick", "#clsItems [data-dragid]", function(){
    if(!isTouch()) return;
    state.selectedForTap = $(this).attr("data-dragid");
    render();
  });

  // Touch: tap category to assign
  $("#stage").off("click.clsCat").on("click.clsCat", "#clsCats [data-dropid]", function(e){
    if(!isTouch()) return;
    // ignore if user clicked X
    if($(e.target).closest("[data-unassign]").length) return;

    const catId = $(this).attr("data-dropid");
    if(!state.selectedForTap){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§"); return; }

    state.q.catAssign = state.q.catAssign || {};
    state.q.catAssign[String(state.selectedForTap)] = String(catId);
    state.selectedForTap = null;
    render();
  });

  // Remove assignment (X)
  $("#stage").off("click.clsRemove").on("click.clsRemove", "[data-unassign]", function(e){
    e.stopPropagation();
    const itemId = $(this).attr("data-unassign");
    if(!itemId) return;
    if(state.q.catAssign) delete state.q.catAssign[String(itemId)];
    render();
  });

  wireFooter();
}

/* =========================
  OTHER RENDERERS (kept minimal for this patch)
  - Your existing functions stay as-is:
    renderChoice, renderMatch, renderDragDrop, renderOrdering, renderBuild, renderColoring, renderTrace, renderUnsupported
  - Keep your existing validate(), render(), load() as you already have
========================= */

/* =========================
  MAIN RENDER SWITCH (USE YOUR EXISTING ONE)
========================= */
async function render(){
  wireFooter();

  if(!state.flow.length){
    setTop({title:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©", sub:"ØªØ­Ù‚Ù‚ Ù…Ù† questionBank", lesson:state.lesson?.title||"â€”", progress:"0/0", type:"â€”", audioUrl:""});
    $("#stage").html(`<div class="panelKid">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</div>`);
    return;
  }

  const entry = curEntry();
  entry.q = resolveQuestion(entry);
  const q = entry.q;
  const type = String(q.type||"");

  // IMPORTANT: keep your other renderers here exactly as in your project
  if(type === "classification") return renderClassification(entry);

  // fallback (so the file runs even if you paste only this patch)
  $("#stage").html(`<div class="panelKid">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ ÙÙ‚Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±ÙŠÙ†Ø¯Ø±Ø² Ù…Ù† ÙƒÙˆØ¯Ùƒ.</div>`);
}

/* =========================
  LOAD (same as yours)
========================= */
async function load(){
  try{
    resetQ();
    $("#stage").text("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");

    const res = await fetch(DATA_FILE, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const level = findBy(data?.levels, "levelId", levelId);
    if(!level) throw new Error(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ levelId=${levelId}`);

    const {sec, les} = (function(){
      const sec = findBy(level?.sections, "sectionId", sectionId);
      if(!sec) return {sec:null, les:null};
      const les = (Array.isArray(sec.lessons)?sec.lessons:[])
        .find(L => String(L.lessonId||"") === String(lessonId)) || null;
      return {sec, les};
    })();

    if(!sec) throw new Error(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ section=${sectionId}`);
    if(!les) throw new Error(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ lesson=${lessonId}`);

    state.data=data; state.level=level; state.section=sec; state.lesson=les;
    state.flow = buildFlow(les);
    state.idx = 0;

    await render();
  }catch(e){
    setTop({title:"ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„", sub:"ØªØ£ÙƒØ¯ Ù…Ù† sections-lessens.json ÙˆØ§Ù„Ù…Ø³Ø§Ø±", lesson:"â€”", progress:"â€”", type:"âš ï¸", audioUrl:""});
    $("#stage").html(`
      <div class="panelKid">
        <div style="font-weight:1000;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£</div>
        <div class="mt-2" style="color:rgba(15,23,42,.65);font-weight:900;line-height:1.7;">${esc(e?.message||"")}</div>
        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnPrimary px-3" id="retry" type="button">ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
        </div>
      </div>
    `);
    $("#retry").off("click").on("click", load);
  }
}

load();
</script>
</body>
</html>
